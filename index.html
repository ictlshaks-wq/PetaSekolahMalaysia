<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Peta Digital Sekolah Malaysia</title>

<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<style>
#map{height:calc(100vh - 120px)}
.school-label{
 background:white;border:1px solid #cbd5e1;
 padding:2px 6px;border-radius:6px;
 font-size:10px;font-weight:900;
 text-transform:uppercase
}
</style>
</head>

<body class="bg-slate-50">

<header class="bg-white shadow p-3 flex gap-2 flex-wrap">
<select id="fNegeri" onchange="updatePPD()" class="border px-2 py-1">
<option value="">Semua Negeri</option>
</select>

<select id="fPPD" onchange="applyFilter()" class="border px-2 py-1">
<option value="">Semua PPD</option>
</select>

<select id="fJenis" onchange="applyFilter()" class="border px-2 py-1">
<option value="">Semua Jenis</option>
</select>

<input id="q" oninput="applyFilter()" placeholder="Cari sekolah..." class="border px-2 py-1">
</header>

<div id="map"></div>

<script>
// =====================
// TUKAR LINK CSV SINI
// =====================
const CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ4hR_b6YVHOkWpeWvFVdFYKXLAVeYUOoaDd310UMc6dtXPVq9NuJaIEdU3hEzjgoLk34vaBu9afFCm/pub?output=csv";

// =====================
const map = L.map('map').setView([4.5,102],7);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
const clusters = L.markerClusterGroup();
map.addLayer(clusters);

let allData=[];
let negeriMap={};

function parseCSV(text){
 const lines=text.trim().split("\n");
 const headers=lines[0].split(",");
 return lines.slice(1).map(row=>{
  const cols=row.split(",");
  let obj={};
  headers.forEach((h,i)=>obj[h.trim()]=cols[i]?.trim());
  return obj;
 });
}

function toNum(v){
 if(!v) return NaN;
 return Number(String(v).replace(",","."));
}

async function loadData(){
 const res=await fetch(CSV_URL+"&_="+Date.now());
 const txt=await res.text();
 const rows=parseCSV(txt);

 allData=rows.map(r=>({
  negeri:r["NEGERI"],
  ppd:r["PPD"],
  jenis:r["JENIS/LABEL"],
  kod:r["KODSEKOLAH"],
  nama:r["NAMASEKOLAH"],
  lat:toNum(r["KOORDINATYY"]),
  lng:toNum(r["KOORDINATXX"])
 })).filter(s=>Number.isFinite(s.lat)&&Number.isFinite(s.lng));

 initFilters();
 draw(allData);
}

function initFilters(){
 negeriMap={};
 const negeriSet=new Set();
 const jenisSet=new Set();

 allData.forEach(s=>{
  negeriSet.add(s.negeri);
  jenisSet.add(s.jenis);
  if(!negeriMap[s.negeri]) negeriMap[s.negeri]=new Set();
  negeriMap[s.negeri].add(s.ppd);
 });

 const fNeg=document.getElementById("fNegeri");
 const fPPD=document.getElementById("fPPD");
 const fJenis=document.getElementById("fJenis");

 while(fNeg.options.length>1)fNeg.remove(1);
 while(fPPD.options.length>1)fPPD.remove(1);
 while(fJenis.options.length>1)fJenis.remove(1);

 [...negeriSet].sort().forEach(n=>fNeg.add(new Option(n,n)));
 [...jenisSet].sort().forEach(j=>fJenis.add(new Option(j,j)));
}

function updatePPD(){
 const negeri=fNegeri.value;
 const fPPD=document.getElementById("fPPD");
 while(fPPD.options.length>1)fPPD.remove(1);
 if(negeri && negeriMap[negeri]){
  [...negeriMap[negeri]].sort().forEach(p=>fPPD.add(new Option(p,p)));
 }
 applyFilter();
}

function draw(list){
 clusters.clearLayers();
 list.forEach(s=>{
  const isSM=s.jenis?.toUpperCase().includes("SM");
  const color=isSM?"#dc2626":"#2563eb";

  const icon=L.divIcon({
   html:`<div style="background:white;border:2px solid ${color};border-radius:10px;width:34px;height:34px;display:flex;align-items:center;justify-content:center;color:${color}">üè´</div>`,
   iconSize:[34,34]
  });

  const m=L.marker([s.lat,s.lng],{icon});
  m.bindTooltip(s.nama,{permanent:true,className:"school-label",direction:"top"});
  clusters.addLayer(m);
 });
}

function applyFilter(){
 const n=fNegeri.value;
 const p=fPPD.value;
 const j=fJenis.value;
 const q=document.getElementById("q").value.toLowerCase();

 const f=allData.filter(s=>
  (!n||s.negeri===n)&&
  (!p||s.ppd===p)&&
  (!j||s.jenis===j)&&
  (!q||s.nama.toLowerCase().includes(q)||s.kod.toLowerCase().includes(q))
 );
 draw(f);
}

loadData();
</script>
</body>
</html>
